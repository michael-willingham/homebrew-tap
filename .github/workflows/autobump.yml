name: Auto-update formulas and casks

on:
  schedule:
    # Run daily at midnight UTC
    - cron: "0 0 * * *"
  workflow_dispatch:  # Allow manual triggering

jobs:
  autobump-netlogo:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Configure Git user
        uses: Homebrew/actions/git-user-config@master
        with:
          username: michael-willingham

      - name: Check for outdated casks
        id: check
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get current version from cask file
          CURRENT_VERSION=$(grep 'version' Casks/netlogo.rb | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "Current version: $CURRENT_VERSION"

          # Get latest version from GitHub releases
          LATEST_VERSION=$(gh api repos/NetLogo/NetLogo/releases/latest --jq '.tag_name' | sed 's/^v//')
          echo "Latest version: $LATEST_VERSION"

          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "outdated=true" >> "$GITHUB_OUTPUT"
            echo "NetLogo is outdated: $CURRENT_VERSION => $LATEST_VERSION"
          else
            echo "outdated=false" >> "$GITHUB_OUTPUT"
            echo "NetLogo is up to date"
          fi

      - name: Bump NetLogo cask
        if: steps.check.outputs.outdated == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get latest version from GitHub releases
          LATEST_VERSION=$(gh api repos/NetLogo/NetLogo/releases/latest --jq '.tag_name' | sed 's/^v//')
          echo "Latest NetLogo version: $LATEST_VERSION"

          # Download both architectures and calculate SHA256
          AARCH64_URL="https://github.com/NetLogo/NetLogo/releases/download/v${LATEST_VERSION}/NetLogo-${LATEST_VERSION}-aarch64.dmg"
          X86_64_URL="https://github.com/NetLogo/NetLogo/releases/download/v${LATEST_VERSION}/NetLogo-${LATEST_VERSION}-x86_64.dmg"

          echo "Downloading aarch64 DMG..."
          AARCH64_SHA256=$(curl -sL "$AARCH64_URL" | shasum -a 256 | awk '{print $1}')
          echo "aarch64 SHA256: $AARCH64_SHA256"

          echo "Downloading x86_64 DMG..."
          X86_64_SHA256=$(curl -sL "$X86_64_URL" | shasum -a 256 | awk '{print $1}')
          echo "x86_64 SHA256: $X86_64_SHA256"

          # Update the cask file
          sed -i '' "s/version \"[^\"]*\"/version \"${LATEST_VERSION}\"/" Casks/netlogo.rb
          sed -i '' "s/sha256 arm:   \"[^\"]*\"/sha256 arm:   \"${AARCH64_SHA256}\"/" Casks/netlogo.rb
          sed -i '' "s/intel: \"[^\"]*\"/intel: \"${X86_64_SHA256}\"/" Casks/netlogo.rb

          # Commit and push changes
          git add Casks/netlogo.rb
          git commit -m "Bump NetLogo to ${LATEST_VERSION}"
          git push

  autobump-zigflow:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git user
        uses: Homebrew/actions/git-user-config@master
        with:
          username: michael-willingham

      - name: Check for new zigflow release
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_VERSION=$(grep 'version' Formula/zigflow.rb | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "Current version: $CURRENT_VERSION"

          LATEST_VERSION=$(gh api repos/mrsimonemms/zigflow/releases/latest --jq '.tag_name' | sed 's/^v//')
          echo "Latest version: $LATEST_VERSION"

          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "outdated=true" >> "$GITHUB_OUTPUT"
            echo "new_version=${LATEST_VERSION}" >> "$GITHUB_OUTPUT"
            echo "Zigflow is outdated: $CURRENT_VERSION => $LATEST_VERSION"
          else
            echo "outdated=false" >> "$GITHUB_OUTPUT"
            echo "Zigflow is up to date"
          fi

      - name: Bump zigflow formula
        if: steps.check.outputs.outdated == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_VERSION="${{ steps.check.outputs.new_version }}"
          echo "Updating zigflow to ${LATEST_VERSION}"

          # Download the checksums file from the release
          CHECKSUMS=$(curl -sL "https://github.com/mrsimonemms/zigflow/releases/download/v${LATEST_VERSION}/checksums.txt")

          DARWIN_ARM64_SHA=$(echo "$CHECKSUMS" | grep 'zigflow_darwin_arm64$' | awk '{print $1}')
          DARWIN_X86_64_SHA=$(echo "$CHECKSUMS" | grep 'zigflow_darwin_x86_64$' | awk '{print $1}')
          LINUX_ARM64_SHA=$(echo "$CHECKSUMS" | grep 'zigflow_linux_arm64$' | awk '{print $1}')
          LINUX_X86_64_SHA=$(echo "$CHECKSUMS" | grep 'zigflow_linux_x86_64$' | awk '{print $1}')

          echo "darwin_arm64:  $DARWIN_ARM64_SHA"
          echo "darwin_x86_64: $DARWIN_X86_64_SHA"
          echo "linux_arm64:   $LINUX_ARM64_SHA"
          echo "linux_x86_64:  $LINUX_X86_64_SHA"

          # Update version
          sed -i '' "s/version \"[^\"]*\"/version \"${LATEST_VERSION}\"/" Formula/zigflow.rb

          # Update SHA256 checksums
          # Each url line is followed by its sha256 line, so use sed to find
          # the url line by binary name and replace the sha256 on the next line
          sed -i '' "/zigflow_darwin_arm64/{n;s/sha256 \"[a-f0-9]*\"/sha256 \"${DARWIN_ARM64_SHA}\"/;}" Formula/zigflow.rb
          sed -i '' "/zigflow_darwin_x86_64/{n;s/sha256 \"[a-f0-9]*\"/sha256 \"${DARWIN_X86_64_SHA}\"/;}" Formula/zigflow.rb
          sed -i '' "/zigflow_linux_arm64/{n;s/sha256 \"[a-f0-9]*\"/sha256 \"${LINUX_ARM64_SHA}\"/;}" Formula/zigflow.rb
          sed -i '' "/zigflow_linux_x86_64/{n;s/sha256 \"[a-f0-9]*\"/sha256 \"${LINUX_X86_64_SHA}\"/;}" Formula/zigflow.rb

          # Commit and push changes
          git add Formula/zigflow.rb
          git commit -m "Bump zigflow to ${LATEST_VERSION}"
          git push
