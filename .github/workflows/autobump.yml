name: Auto-update NetLogo cask

on:
  schedule:
    # Run every 6 hours
    - cron: "0 */6 * * *"
  workflow_dispatch:  # Allow manual triggering

jobs:
  autobump:
    runs-on: macos-latest
    steps:
      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Configure Git user
        uses: Homebrew/actions/git-user-config@master
        with:
          username: michael-willingham

      - name: Check for outdated casks
        id: check
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd "$(brew --repository michael-willingham/homebrew-tap)"
          
          # Check if NetLogo is outdated
          OUTDATED=$(brew livecheck --tap=michael-willingham/homebrew-tap --cask netlogo --quiet)
          
          if [ -n "$OUTDATED" ]; then
            echo "outdated=true" >> $GITHUB_OUTPUT
            echo "NetLogo is outdated: $OUTDATED"
          else
            echo "outdated=false" >> $GITHUB_OUTPUT
            echo "NetLogo is up to date"
          fi

      - name: Bump NetLogo cask
        if: steps.check.outputs.outdated == 'true'
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd "$(brew --repository michael-willingham/homebrew-tap)"
          
          # Bump the cask (downloads new version, calculates SHA256, updates file)
          brew bump-cask-pr \
            --no-browse \
            --no-fork \
            --write-only \
            netlogo
          
          # Commit and push changes
          git add Casks/netlogo.rb
          git commit -m "Bump NetLogo to $(brew livecheck --cask netlogo --json | jq -r '.[0].version.latest')"
          git push origin main
