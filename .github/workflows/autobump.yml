name: Auto-update NetLogo cask

on:
  schedule:
    # Run daily at midnight UTC
    - cron: "0 0 * * *"
  workflow_dispatch:  # Allow manual triggering

jobs:
  autobump:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Configure Git user
        uses: Homebrew/actions/git-user-config@master
        with:
          username: michael-willingham

      - name: Check for outdated casks
        id: check
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get current version from cask file
          CURRENT_VERSION=$(grep 'version' Casks/netlogo.rb | head -1 | sed 's/.*"\(.*\)".*/\1/')
          echo "Current version: $CURRENT_VERSION"
          
          # Get latest version from GitHub releases
          LATEST_VERSION=$(gh api repos/NetLogo/NetLogo/releases/latest --jq '.tag_name' | sed 's/^v//')
          echo "Latest version: $LATEST_VERSION"
          
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "outdated=true" >> "$GITHUB_OUTPUT"
            echo "NetLogo is outdated: $CURRENT_VERSION => $LATEST_VERSION"
          else
            echo "outdated=false" >> "$GITHUB_OUTPUT"
            echo "NetLogo is up to date"
          fi

      - name: Bump NetLogo cask
        if: steps.check.outputs.outdated == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get latest version from GitHub releases
          LATEST_VERSION=$(gh api repos/NetLogo/NetLogo/releases/latest --jq '.tag_name' | sed 's/^v//')
          echo "Latest NetLogo version: $LATEST_VERSION"
          
          # Download both architectures and calculate SHA256
          AARCH64_URL="https://github.com/NetLogo/NetLogo/releases/download/v${LATEST_VERSION}/NetLogo-${LATEST_VERSION}-aarch64.dmg"
          X86_64_URL="https://github.com/NetLogo/NetLogo/releases/download/v${LATEST_VERSION}/NetLogo-${LATEST_VERSION}-x86_64.dmg"
          
          echo "Downloading aarch64 DMG..."
          AARCH64_SHA256=$(curl -sL "$AARCH64_URL" | shasum -a 256 | awk '{print $1}')
          echo "aarch64 SHA256: $AARCH64_SHA256"
          
          echo "Downloading x86_64 DMG..."
          X86_64_SHA256=$(curl -sL "$X86_64_URL" | shasum -a 256 | awk '{print $1}')
          echo "x86_64 SHA256: $X86_64_SHA256"
          
          # Update the cask file
          sed -i '' "s/version \"[^\"]*\"/version \"${LATEST_VERSION}\"/" Casks/netlogo.rb
          sed -i '' "s/sha256 arm:   \"[^\"]*\"/sha256 arm:   \"${AARCH64_SHA256}\"/" Casks/netlogo.rb
          sed -i '' "s/intel: \"[^\"]*\"/intel: \"${X86_64_SHA256}\"/" Casks/netlogo.rb
          
          # Commit and push changes
          git add Casks/netlogo.rb
          git commit -m "Bump NetLogo to ${LATEST_VERSION}"
          git push
